<!doctype html>
<html lang="en">
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=0.1, maximum-scale=10.0, user-scalable=yes, viewport-fit=cover">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3"></script>
  <style>
    /* ---------- Base layout ---------- */
    html, body { height: auto; } /* Adjusted for full scrolling */
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0; padding: 0;
      background: linear-gradient(135deg, #1A2A44 0%, #0D1B2A 100%);
      min-height: 100vh; overflow: auto; color: #ECF0F1; /* Enabled body vertical and horizontal scroll */
      font-size: clamp(14px, 2vw, 16px); line-height: 1.6;
      display: block;
      transition: all 0.3s ease;
      /* Enhanced mobile scrolling */
      -webkit-overflow-scrolling: touch;
      scroll-behavior: smooth;
    }
    /* === AUTH GUARD: hide the entire app UI until body has .auth === */
    body:not(.auth) #navbar,
    body:not(.auth) #top-menu,
    body:not(.auth) #sidebar,
    body:not(.auth) #content,
    body:not(.auth) #chartModal,
    body:not(.auth) #chartBackdrop,
    body:not(.auth) .modal,
    body:not(.auth) .loading-overlay {
      display: none !important;
    }
    /* Everything in the app is inside this wrapper so we can rotate it on phones */
    #app { display: flex; flex-direction: column; align-items: center; }
    #login-container {
      display: none; position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%) scale(0.95);
      background: linear-gradient(135deg, #2E4057 0%, #1A2A44 100%);
      padding: 40px; border-radius: 16px; z-index: 10000;
      box-shadow: 0 12px 48px rgba(0,0,0,0.6); border: 1px solid #D4A017;
      opacity: 0; animation: loginFadeIn 0.5s ease forwards;
      text-align: center;
      max-width: 300px;
      width: 90vw;
    }
    #login-container .logo {
      font-family:'Inter','Segoe UI',Arial,sans-serif; font-size:2.5em; font-weight:bold; color:#ffd605;
      position:relative; display:block; overflow:hidden; white-space:nowrap; margin-bottom: 24px;
      --letters: 11; animation: signatureWrite 4s steps(var(--letters), end) infinite;
    }
    @keyframes signatureWrite { 0%{clip-path:inset(0 100% 0 0);opacity:0;} 10%{opacity:1;} 50%{clip-path:inset(0 0 0 0);opacity:1;} 100%{clip-path:inset(0 0 0 0);opacity:1;} }
    @media (prefers-reduced-motion: reduce){ #login-container .logo{ animation:none; } }
    #login-container .input-group {
      margin: 16px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #login-container label {
      align-self: flex-start;
      font-weight: 600;
      color: #ffd605;
      margin-bottom: 6px;
      font-size: 0.95em;
    }
    #login-container input {
      padding: 14px 16px; width: 100%; max-width: 280px;
      border: 1px solid #D4A017; border-radius: 8px;
      background: #1e293b; color: #ECF0F1;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      font-size: 1em;
      box-sizing: border-box;
    }
    #login-container input:focus{ border-color:#26A69A; box-shadow:0 0 8px rgba(38,166,154,0.5); outline: none; }
    #login-container input::placeholder {
      color: #94a3b8;
    }
    #login-container button{
      padding:14px 32px; margin:20px 0 8px 0; background:linear-gradient(45deg,#D4A017,#ffd605);
      border:none; color:#1A2A44; cursor:pointer; border-radius:8px;
      transition: transform .3s ease, box-shadow .3s ease; font-weight:600; font-size: 1em;
      width: 100%; max-width: 280px;
    }
    #login-container button:hover { transform: scale(1.02); box-shadow: 0 6px 20px rgba(212,160,23,0.5); }
    #navbar {
      background: linear-gradient(90deg, #1b263b 0%, #2E4057 100%);
      color: #fff; padding:16px 32px; position:fixed; top:0; width:100%;
      z-index:1000; box-shadow:0 4px 16px rgba(0,0,0,0.4);
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:2px solid #D4A017; transition: all .3s ease;
    }
    #toggle-nav {
      background:none; border:none; color:#D4A017; font-size:28px; cursor:pointer; padding:8px;
      transition: transform .3s ease, color .3s ease;
    }
    #toggle-nav:hover { transform: rotate(90deg); color: #26A69A; }
    #navbar .logo{
      font-family:'Inter','Segoe UI',Arial,sans-serif; font-size:1.5em; font-weight:bold; color:#ffd605;
      position:relative; display:inline-block; overflow:hidden; white-space:nowrap;
      --letters: 11; animation: signatureWrite 4s steps(var(--letters), end) infinite;
    }
    @keyframes signatureWrite { 0%{clip-path:inset(0 100% 0 0);opacity:0;} 10%{opacity:1;} 50%{clip-path:inset(0 0 0 0);opacity:1;} 100%{clip-path:inset(0 0 0 0);opacity:1;} }
    @media (prefers-reduced-motion: reduce){ #navbar .logo{ animation:none; } }
    #timestamp{
      background: linear-gradient(45deg, #26A69A, #10b981);
      padding:12px 20px; border-radius:28px; box-shadow:0 4px 12px rgba(16,185,129,0.3);
      color:#fff; font-weight:600; display:flex; align-items:center; gap:8px; margin-left:auto;
    }
    #timestamp .emoji { animation: bounce 1s infinite; }
    #logout-btn{
      padding:12px 20px; background:linear-gradient(45deg,#D4A017,#ffd605);
      border:none; color:#1A2A44; cursor:pointer; border-radius:8px; transition: transform .3s, box-shadow .3s; margin-left:16px; font-weight:600;
      display:none;
    }
    #logout-btn:hover{ transform: scale(1.05); box-shadow:0 6px 20px rgba(212,160,23,0.5); }
    #top-menu{
      background: linear-gradient(90deg, #2E4057 0%, #34495E 100%);
      padding:16px 32px; position:fixed; top:64px; left:0; width:100%; z-index:1001;
      display:flex; flex-wrap:wrap; gap:24px; justify-content:center;
      box-shadow:0 4px 16px rgba(0,0,0,0.4); border-bottom:2px solid #D4A017;
      transition: all .3s ease;
    }
    .top-menu-group{ margin:6px 0; position:relative; }
    .top-menu-group-header{
      background:linear-gradient(45deg,#D4A017,#ffd605); border:1px solid #ffd605; color:#1A2A44;
      padding:14px 24px; border-radius:8px; cursor:pointer; text-align:center;
      transition: transform .3s, box-shadow .3s; font-weight:600; min-width:180px;
    }
    .top-menu-group-header:hover{ transform: scale(1.05); box-shadow:0 6px 20px rgba(212,160,23,.5); }
    .top-menu-group-header.open{ background:linear-gradient(45deg,#26A69A,#10b981); color:#fff; border-color:#10b981; }
    .top-menu-group-header::after{ content:'â–¼'; position:absolute; right:12px; transition: transform .3s; }
    .top-menu-group-header.open::after{ transform: rotate(180deg); }
    .top-menu-group-content{
      display:none; position:absolute; top:100%; left:50%; transform: translateX(-50%);
      flex-direction:column; gap:12px; padding:12px; background:#34495E; border-radius:8px;
      box-shadow:0 4px 12px rgba(0,0,0,.5); border:1px solid #D4A017; z-index:1002; min-width:220px;
    }
    .top-menu-group-content.open{ display:flex; }
    .top-menu-group-content button{
      background:linear-gradient(45deg,#D4A017,#ffd605); border:1px solid #ffd605; color:#1A2A44; padding:12px 20px; border-radius:6px;
      cursor:pointer; transition: transform .3s, box-shadow .3s; font-weight:600; text-align:center; width:100%;
    }
    .top-menu-group-content button:hover{ transform:scale(1.05); box-shadow:0 4px 12px rgba(212,160,23,.5); }
    .top-menu-group-content button.active{ background:linear-gradient(45deg,#26A69A,#10b981); color:#fff; border-color:#10b981; box-shadow:0 4px 12px rgba(16,185,129,.4); }
    #sidebar{
      position:fixed; top:128px; left:0; width:320px; height:calc(100vh - 128px);
      background:linear-gradient(135deg,#34495E 0%,#2E4057 100%); color:#ECF0F1; padding:24px;
      overflow-y:auto; transform:translateX(-100%); transition:transform .4s ease-in-out; z-index:999;
      border-right:2px solid #D4A017; box-shadow:4px 0 20px rgba(0,0,0,0.4);
      /* Enhanced mobile scrolling for sidebar */
      -webkit-overflow-scrolling: touch;
    }
    #sidebar.fullscreen{ top:0; left:0; width:100%; height:100%; transform:translateX(0); background:linear-gradient(135deg,#34495E 0%,#2E4057 100%); z-index:1002; }
    #sidebar.active{ transform:translateX(0); }
    .group{ background:#2E4057; border-radius:12px; margin-bottom:16px; overflow:hidden; border:1px solid #D4A017; }
    .group h3{
      margin:0; font-size:18px; padding:16px; background:linear-gradient(45deg,#D4A017,#ffd605);
      border-radius:12px 12px 0 0; cursor:pointer; display:flex; justify-content:space-between; align-items:center;
      font-weight:600; color:#1A2A44;
    }
    .group h3::after{ content:'â–¶'; font-size:14px; transition: transform .3s; }
    .group h3.open::after{ transform:rotate(90deg); }
    .sheet-list{ list-style:none; padding-left:16px; margin:12px 0 0 0; display:none; background:#2E4057; }
    .sheet-list li{
      padding:14px; color:#ECF0F1; cursor:pointer; border-radius:6px; background:#34495E; margin:6px 0; font-weight:600; transition: all .3s;
    }
    .sheet-list li:hover{ background:#26A69A; color:#fff; transform: translateX(5px); }
    #content{
      margin-top:140px;
      padding:24px 12px;
      transition: margin-left .4s ease;
      width:100%;
      box-sizing:border-box;
      overflow-y: visible;
      overflow-x: visible;
      /* Enhanced mobile scrolling for content */
      -webkit-overflow-scrolling: touch;
    }
    #sidebar.active + #content{ margin-left:320px; }
    #sidebar.fullscreen + #content{ opacity:0.5; }
    /* table & wrapper - Remove internal vertical scroll for single page scroll */
    #table-tools{ width:100%; max-width:none; margin:0 0 8px 0; display:flex; align-items:center; justify-content:space-between; gap:12px; }
    #updateTimeBadge{ margin-left:auto; font-weight:800; color:#ffd605; background:rgba(255,255,255,0.06); border:1px solid rgba(212,160,23,0.6); padding:6px 10px; border-radius:10px; }
    #table-container{
      overflow-x: auto;
      overflow-y: auto;
      max-height: calc(100vh - 250px);
      width:100%; max-width:none; display:block; position:relative; will-change:scroll-position; border:2px solid #D4A017; border-radius:12px; box-shadow:0 8px 32px rgba(0,0,0,0.4); background:#fff; margin:0;
      /* Improved mobile table scrolling - horizontal only now */
      overscroll-behavior: contain;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
      touch-action: pan-x pan-y;
    }
    #table-container::-webkit-scrollbar { width: 8px; height: 8px; }
    #table-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
    #table-container::-webkit-scrollbar-thumb { background: #D4A017; border-radius: 10px; }
    #table-container::-webkit-scrollbar-thumb:hover { background: #ffd605; }
    #table-container>table{ width: max-content; min-width: 100%; table-layout: auto; border-collapse:separate; border-spacing:0; background:#fff; border-radius:12px; animation: fadeSlideUp .6s ease-out; } /* Changed to auto for auto-fit */
    #table-container>table.domain-realtime{ table-layout:auto; }
    .mini-table{ width:auto; display:inline-table; margin:0; }
    .mini-table th, .mini-table td{ white-space:nowrap; }
    #table-container>table th, #table-container>table td{ border:1px solid #D4A017; padding:14px; text-align:center; font-size:14px; font-weight:600; transition: background .3s, color .3s; word-wrap:normal; overflow-wrap: normal; hyphens: none; white-space: nowrap; } /* No wrapping */
    #table-container>table th{ background:linear-gradient(45deg,#D4A017,#ffd605); color:#1A2A44; font-weight:700; text-transform:uppercase; letter-spacing:.8px; cursor:pointer; user-select:none; }
    /* Sticky header now relative to #content scroll */
    #table-container>table th.sticky-header{ position:sticky; top:0; z-index:10; background:linear-gradient(45deg,#D4A017,#ffd605); box-shadow:0 2px 4px rgba(0,0,0,0.3); }
    #table-container>table th .sort-caret{ margin-left:6px; font-size:12px; opacity:.9; }
    #table-container>table td{ background:#F5F5F5; color:#000; white-space: nowrap; } /* Enforce no-wrap */
    #table-container>table td.sticky-left{ position:sticky; left:0; background:#F5F5F5; z-index:5; }
    #table-container>table th.sticky-left { position: sticky; left: 0; z-index: 11; background: linear-gradient(45deg,#D4A017,#ffd605); } /* Added for freezing first column header */
    #table-container>table th.sticky-corner { position: sticky; top: 0; left: 0; z-index: 12; background: linear-gradient(45deg,#D4A017,#ffd605); } /* For corner cell */
    #table-container>table tr:nth-child(even) td{ background:#e5e7eb; }
    #table-container>table tr:hover td{ background:linear-gradient(45deg,#26A69A,#10b981); color:#fff; }
    .numeric-negative{ color:#cf2525 !important; font-weight:bold; }
    .percentage-negative{ color:#cf2525 !important; font-weight:bold; }
    .status-good{ color:#10b981; font-weight:bold; }
    .status-medium{ color:#f59e0b; font-weight:bold; }
    .status-bad{ color:#cf2525; font-weight:bold; }
    .error-remark{ color:#cf2525; font-weight:bold; }
    .ok-remark{ color:#1c694f; font-weight:bold; }
    .accounting-format{ text-align:center; }
    a.link-view{ color:#083873; text-decoration:none; cursor:pointer; font-weight:600; padding:6px 10px; border-radius:6px; transition: background .2s; }
    a.link-view:hover{ background:#1e40af; color:#fff; }
    .rank-top-1{ background:linear-gradient(45deg,#ffd605,#f9db42)!important; color:#000; font-weight:bold; animation:pulse 1.5s infinite; }
    .rank-top-2{ background:linear-gradient(45deg,#f9db42,#f7df62)!important; color:#000; font-weight:bold; }
    .rank-top-3{ background:linear-gradient(45deg,#f7df62,#fde785)!important; color:#000; font-weight:bold; }
    .rank-top-4{ background:linear-gradient(45deg,#fde785,#ffefa6)!important; color:#000; font-weight:bold; }
    .rank-top-5{ background:linear-gradient(45deg,#ffefa6,#ffffff)!important; color:#000; font-weight:bold; }
    .highlight-row{ background:none !important; border-bottom:2px solid #ffd605 !important; }
    .highlight-row td{ background:linear-gradient(45deg,#D4A017,#ffd605)!important; color:#1A2A44!important; text-transform:uppercase!important; font-weight:700!important; z-index:6!important; }
    .highlight-row td.sticky-left{ background:linear-gradient(45deg,#D4A017,#ffd605)!important; z-index:7!important; }
    .error-text{ color:#cf2525; font-weight:bold; }
    .ok-text{ color:#1c694f; font-weight:bold; }
    .loading-overlay{
      display:none; position:fixed; inset:0; background:linear-gradient(135deg,#1A2A44 0%, #0D1B2A 100%); z-index:9998;
      justify-content:center; align-items:center;
    }
    .loading-spinner{ width:60px; height:60px; border:6px solid #D4A017; border-top:6px solid #26A69A; border-radius:50%; animation: spin .8s linear infinite; }
    .modal{ display:none; position:fixed; z-index:9999; padding-top:80px; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,.9); }
    .modal-content{ margin:auto; display:block; max-width:90%; max-height:80vh; border-radius:12px; box-shadow:0 0 30px rgba(0,0,0,0.6); animation: zoomIn .4s ease-in-out; font-weight:bold; }
    .close{ position:absolute; top:24px; right:48px; color:#D4A017; font-size:48px; font-weight:bold; cursor:pointer; transition: color .3s, transform .2s; }
    .close:hover{ color:#26A69A; transform: scale(1.2); }
    .sidebar-backdrop{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:1001; }
    @keyframes loginFadeIn{ from{opacity:0; transform:translate(-50%,-50%) scale(.95);} to{opacity:1; transform:translate(-50%,-50%) scale(1);} }
    @keyframes fadeSlideUp{ from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }
    @keyframes fadeIn{ from{opacity:0;} to{opacity:1;} }
    @keyframes zoomIn{ from{transform:scale(.8); opacity:0;} to{transform:scale(1); opacity:1;} }
    @keyframes spin{ 0%{transform:rotate(0);} 100%{transform:rotate(360deg);} }
    @keyframes pulse{ 0%{transform:scale(1);} 50%{transform:scale(1.05);} 100%{transform:scale(1);} }
    @keyframes bounce{ 0%,20%,50%,80%,100%{transform:translateY(0);} 40%{transform:translateY(-10px);} 60%{transform:translateY(-5px);} }
    @media (max-width:768px){
      #navbar{ padding:12px 16px; }
      #sidebar{ width:100%; top:64px; height:calc(100vh - 64px); padding:12px; /* Reduced padding for easier touch */ }
      #content{
        margin-top:110px;
        padding:12px;
        /* Removed fixed height for full page scroll */
        overflow-y: visible;
        overflow-x: visible;
        margin-left:0;
        /* Enhanced mobile scrolling for content */
        -webkit-overflow-scrolling: touch;
      }
      #table-container>table{ table-layout:auto; min-width:100%; }
      th,td{
        min-width:auto;
        padding:8px 4px;
        font-size:12px;
        /* Removed wrapping overrides - keep nowrap from base */
        white-space: nowrap !important;
        word-break: normal !important;
        word-wrap: normal !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        line-height: 1.3;
        vertical-align: top;
        hyphens: none;
        max-width: none; /* Remove max-width to allow auto-fit */
      }
      #top-menu{ flex-direction:column; align-items:center; padding:12px; gap:8px; /* Tighter spacing */ }
      .top-menu-group, .top-menu-group-header, .top-menu-group-content{ width:100%; position:static; transform:none; }
      #table-tools{ flex-direction:column; align-items:flex-start; gap:8px; }
      #updateTimeBadge{ align-self:flex-end; font-size:0.9em; /* Smaller badge */ }
      /* Mobile-specific table enhancements */
      #table-container { border-radius: 8px; overflow-x: auto; overflow-y: auto; max-height: calc(100vh - 200px); }
      #table-container::before {
        content: 'â†” Swipe left/right to scroll';
        position: absolute; top: -30px; left: 0; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; font-size: 10px; border-radius: 4px; opacity: 0; transition: opacity 0.3s;
        pointer-events: none; z-index: 1;
      }
      #table-container:hover::before { opacity: 1; }
      /* Full screen chart modal on mobile - enhanced for landscape */
      .chart-modal {
        inset: 0 !important;
        padding: 8px;
        border-radius: 0;
        max-width: none !important;
        max-height: none !important;
        width: 100vw !important;
        height: 100vh !important;
        overflow-y: auto;
        overflow-x: hidden;
      }
      .chart-backdrop {
        inset: 0 !important;
        z-index: 10000;
      }
      /* Ensure dropdowns (selects) are full width, native, and adapt to landscape */
      .filters select {
        width: 100% !important;
        min-width: unset !important;
        max-width: none !important;
        -webkit-appearance: menulist !important;
        appearance: menulist !important;
        font-size: 14px;
        padding: 10px;
      }
      .filters .row {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 10px !important;
      }
      .filters label {
        min-width: auto !important;
        width: 100% !important;
        display: block !important;
      }
      .filters .row-tight {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 8px !important;
      }
      .toggle-wrap {
        justify-content: space-between !important;
        width: 100% !important;
      }
      /* Responsive KPIs for chart on mobile - 2 columns */
      .kpis {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 0.5rem;
      }
      .chart-area {
        height: 60vh !important; /* Increased for better visibility and full graph view */
        min-height: 300px !important;
      }
      .table-area {
        margin-top: 0.5rem;
      }
      .table-scroll {
        max-height: 20vh !important; /* Reduced to make table smaller for more graph space */
      }
      /* Landscape specific adjustments for chart modal */
      @media (orientation: landscape) and (max-width: 768px) {
        .chart-modal {
          padding: 4px !important;
        }
        .chart-area {
          height: 75vh !important; /* Further increased in landscape for full view */
        }
        .filters {
          padding: 8px !important;
        }
        .kpis {
          grid-template-columns: repeat(5, 1fr) !important; /* Back to 5 in landscape */
        }
        .table-scroll {
          max-height: 15vh !important; /* Even smaller table in landscape */
        }
        /* Ensure selects do not trigger orientation change - compact and native */
        .filters select {
          font-size: 12px;
          padding: 8px;
          height: 40px; /* Fixed height to prevent layout shift */
        }
        .filters .row-tight {
          gap: 6px !important; /* Tighter in landscape */
        }
        #table-container {
          overflow-x: hidden !important;
        }
        #table-container > table {
          width: 100% !important;
          table-layout: fixed !important;
        }
        #table-container > table th,
        #table-container > table td {
          white-space: normal !important;
          word-wrap: break-word !important;
          overflow-wrap: break-word !important;
          text-overflow: clip !important;
          padding: 4px 2px !important;
          font-size: 10px !important;
        }
        #table-container::before {
          display: none !important;
        }
      }
    }
    /* ---------- Hourly Chart quick styles ---------- */
    #btnHourlyChart.chart-btn{
      padding:10px 14px; background:linear-gradient(45deg,#26A69A,#10b981); border:none; color:#fff; cursor:pointer;
      border-radius:8px; transition: transform .15s, box-shadow .15s; margin-left:12px; font-weight:700; white-space:nowrap;
    }
    #btnHourlyChart.chart-btn:hover{ transform: translateY(-1px); box-shadow:0 6px 20px rgba(16,185,129,.35); }
    .chart-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; z-index:10000; }
    .chart-modal{
      position:fixed; inset:5% 4%; background:#fff; color:#1A2A44; border-radius:16px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.35);
      display:none; z-index:10001; border:1px solid #D4A017;
    }
    .chart-modal.show, .chart-backdrop.show{ display:block; }
    .chart-modal .modal-header{ display:flex; align-items:center; justify-content:space-between; gap:1rem; margin-bottom:.75rem; flex-wrap: wrap; }
    .chart-modal .btn{ cursor:pointer; padding:.5rem .8rem; border-radius:10px; border:1px solid #ddd; background:#fff; }
    .chart-modal .btn:hover{ background:#f5f5f5; }
    .muted-sub{ opacity:.75; font-size:.9rem; margin-top:2px; }
    .panel-grid{ display:grid; grid-template-columns:1fr; gap:.75rem; }
    .card-lite{ border:1px dashed #d8d9df; border-radius:12px; padding:.6rem .75rem; background:#fafafa; }
    .card-solid{ border:1px solid #e6e7ec; border-radius:12px; padding:.6rem .6rem; background:#fff; }
    .filters .row{ display:flex; flex-wrap:wrap; gap:.75rem; align-items:flex-end; }
    .filters .row label{ display:flex; flex-direction:column; gap:.25rem; min-width:180px; font-size:.9rem; color:#444; }
    .filters select{ padding:.45rem .6rem; border-radius:10px; border:1px solid #cfd1d7; background:#fff; color:#1A2A44; }
    .row-tight{ justify-content:flex-start; align-items:center; gap:1.25rem; }
    .toggle-wrap{ display:flex; align-items:center; gap:.5rem; }
    .toggle-label{ font-size:.9rem; color:#333; cursor:pointer; }
    .kpis{ display:grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap:.5rem; }
    .kpi{ border:1px solid #e6e7ec; border-radius:12px; padding:.5rem .6rem; background:#fff; }
    .kpi .label{ font-size:.75rem; color:#667085; margin-bottom:2px; }
    .kpi .value{ font-weight:800; font-size:1.05rem; color:#0f172a; }
    .kpi .sub{ font-size:.75rem; color:#6b7280; }
    .chart-area{ height:54vh; min-height:360px; }
    .table-area{ margin-top:.6rem; }
    .table-scroll{ max-height:28vh; overflow:auto; border:1px solid #e6e7ec; border-radius:12px; }
    .hour-table{ width:100%; border-collapse:collapse; font-size:.92rem; }
    .hour-table th, .hour-table td{ border:1px solid #e6e7ec; padding:.5rem; text-align:right; }
    .hour-table th:first-child, .hour-table td:first-child{ text-align:center; }
    .hour-table tr:nth-child(even) td{ background:#fafafa; }
    @media (prefers-color-scheme:dark){
      .chart-modal{ background:#151517; color:#e9e9ea; border-color:#2a2a2c; }
      .card-lite{ background:#131316; border-color:#2a2a2c; }
      .card-solid{ background:#151517; border-color:#2a2a2c; }
      .filters select{ background:#1a1a1d; color:#e9e9ea; border-color:#2a2a2c; }
      .kpi{ background:#161619; border-color:#2a2a2c; }
      .table-scroll{ border-color:#2a2a2c; }
      .hour-table th, .hour-table td{ border-color:#2a2a2c; }
    }
    /* ---------- Net Net AnalysisV2 controls ---------- */
    #netv2-controls{
      display:none; margin: 10px 0 12px 0; background:rgba(255,255,255,0.06);
      border:1px solid rgba(212,160,23,0.6); border-radius:12px; padding:10px 12px; width:max-content;
    }
    #netv2-controls .nnv2-row{ display:flex; align-items:center; gap:.5rem; margin:6px 0; flex-wrap:wrap; }
    #netv2-controls strong{ font-size:.9rem; opacity:.8; margin-right:4px; }
    #netv2-controls .nnv2-seg button{
      border:1px solid #ffd605; background:#ffd605; color:#1A2A44; padding:.3rem .6rem; border-radius:8px; cursor:pointer; font-weight:700; min-width:56px;
    }
    #netv2-controls .nnv2-seg button.active{ background:linear-gradient(45deg,#26A69A,#10b981); color:#fff; border-color:#10b981; }
    #netv2-controls .nnv2-curr .chip{
      display:inline-block; border:1px solid #cfd1d7; background:#fff; color:#1A2A44; padding:.25rem .55rem; border-radius:999px; cursor:pointer; font-weight:700; font-size:.85rem;
    }
    #netv2-controls .nnv2-curr .chip.active{ background:#26A69A; color:#fff; border-color:#26A69A; }
    /* ---------- NetV2 Overall (collapsible) ---------- */
    #netv2-overall{
      position:relative;
      display:inline-block;
      margin:10px 0 6px 12px;
      padding:0;
      box-sizing:border-box;
      vertical-align:top;
      display:none;
    }
    #netv2-overall .collapsible-header{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:8px 14px;
      border-radius:10px;
      background: linear-gradient(90deg,#1b263b,#2E4057);
      border:1px solid rgba(212,160,23,0.6);
      color:#ffd605;
      cursor:pointer;
      user-select:none;
      font-weight:800;
      box-shadow:0 2px 6px rgba(0,0,0,0.25);
    }
    #netv2-overall .title{ color:#ffd605; font-size:0.95rem; padding-left:2px; }
    #netv2-overall .caret{ margin-left:6px; transition:transform .18s ease; color:#ffd605; }
    #netv2-overall:not(.open) .caret{ transform:rotate(-90deg); }
    #netv2-overall .collapsible-content{
      display:none;
      position:absolute;
      left:0;
      top:calc(100% + 8px);
      width:auto;
      max-width:920px;
      background:#fff;
      border-radius:10px;
      border:1px solid #e6e7ec;
      box-shadow:0 10px 30px rgba(0,0,0,0.35);
      padding:8px;
      z-index:1002;
    }
    #netv2-overall.open .collapsible-content{ display:block; }
    #netv2-overall .mini-table{
      width:100%;
      border-collapse:collapse;
      background:#fff;
      color:#0f172a;
      border-radius:6px;
      overflow:hidden;
      margin:6px 0;
      table-layout:fixed;
    }
    #netv2-overall .mini-table th,
    #netv2-overall .mini-table td{
      border:1px solid #e6e7ec;
      padding:8px 10px;
      font-size:13px;
      text-align:center;
      white-space:nowrap;
    }
    #netv2-overall .mini-table th{
      background:#faf5e1;
      color:#1a2a44;
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:.4px;
    }
    #netv2-overall .mini-table tr:nth-child(even) td{ background:#fafafa; }
    #netv2-searchwrap{
      display:flex;
      align-items:center;
      gap:8px;
      width:auto;
      margin:6px 0 16px 12px;
      padding-left:0;
      box-sizing:border-box;
      display:none;
    }
    #netv2-searchwrap label{ opacity:.85; font-weight:700; color:#fff; }
    #netv2-search{ padding:10px 12px; border-radius:10px; border:1px solid #cfd1d7; background:#fff; color:#0f172a; min-width:260px; }
    /* Responsive adjustments */
    @media (max-width:768px){
      #netv2-overall{ max-width:calc(100% - 24px); margin-left:12px; }
      #netv2-overall .mini-table th, #netv2-overall .mini-table td{ padding:6px 8px; font-size:12px; white-space:nowrap; }
      #netv2-search{ min-width:160px; }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Login -->
    <div id="login-container">
      <span class="logo">Pulse Point</span>
      <div class="input-group">
        <label for="username">Username</label>
        <input type="text" id="username" placeholder="Enter your username">
      </div>
      <div class="input-group">
        <label for="password">Password</label>
        <input type="password" id="password" placeholder="Enter your password">
      </div>
      <button onclick="login()">Login</button>
    </div>
    <!-- Navbar -->
    <div id="navbar">
      <button id="toggle-nav">â˜°</button>
      <span class="logo">Pulse Point</span>
      <div id="timestamp"><span class="emoji">ðŸŽ‰</span></div>
      <button id="btnHourlyChart" class="chart-btn" title="Show hourly analysis">Chart</button>
      <button id="logout-btn" onclick="logout()">Logout</button>
    </div>
    <!-- Menus + Sidebar -->
    <div id="top-menu"></div>
    <div id="sidebar"><div id="sidebar-content"></div></div>
    <div class="sidebar-backdrop" onclick="toggleSidebar()"></div>
    <!-- Content -->
    <div id="content">
      <!-- NetV2 filter panel -->
      <div id="netv2-controls"></div>
      <!-- NetV2 Overall panel (collapsible) -->
      <div id="netv2-overall" class="">
        <div class="collapsible-header" onclick="toggleOverallBox()">
          <span id="netv2-overall-title" class="title">Overall</span>
          <span class="caret">â–¾</span>
        </div>
        <div id="netv2-overall-content" class="collapsible-content"></div>
      </div>
      <!-- Search (under Overall) -->
      <div id="netv2-searchwrap">
        <label for="netv2-search">Search:</label>
        <input id="netv2-search" type="text" placeholder="Type to filter visible rowsâ€¦">
      </div>
      <!-- tools line: update time (right) -->
      <div id="table-tools" style="display:none;">
        <span id="updateTimeBadge">Update Time : â€”</span>
      </div>
      <!-- Table -->
      <div id="table-container"></div>
    </div>
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner"></div>
    </div>
    <!-- Image viewer modal -->
    <div id="imgModal" class="modal" role="dialog" aria-modal="true">
      <span class="close" onclick="closeModal(); event.stopPropagation();">&times;</span>
      <img id="modalImage" class="modal-content" alt="Screenshot preview">
    </div>
  </div> <!-- /#app -->
  <!-- Hourly Chart Modal - MOVED OUTSIDE #app TO AVOID ROTATION AND FIX DROPDOWN ORIENTATION ISSUES ON MOBILE -->
  <div id="chartBackdrop" class="chart-backdrop"></div>
  <div id="chartModal" class="chart-modal" role="dialog" aria-modal="true" aria-label="Hourly Analysis">
    <div class="modal-header">
      <div>
        <strong style="font-size:1.05rem;">Hourly Distribution</strong>
        <div class="muted-sub">Hourly Metrics</div>
      </div>
      <div class="header-actions">
        <button id="btnExportCsv" class="btn">Export CSV</button>
        <button id="btnChartClose" class="btn">Close</button>
      </div>
    </div>
    <div class="panel-grid">
      <div class="filters card-lite">
        <div class="row">
          <label>Day
            <select id="chartFilterDay">
              <option value="Analysis Today">Analysis Today</option>
              <option value="Analysis Yesterday">Analysis Yesterday</option>
            </select>
          </label>
          <label>Brand
            <select id="chartFilterBrand">
              <option value="ALL">All Brands</option>
            </select>
          </label>
          <label>Metric
            <select id="chartFilterMetric">
              <option value="registered_count">Registered Count (E)</option>
              <option value="first_deposit_count">First Deposit Count (F)</option>
              <option value="deposit_count">Deposit Count (G)</option>
              <option value="deposit_amount">Deposit Amount (H)</option>
              <option value="withdrawal_count">Withdrawal Count (I)</option>
              <option value="withdrawal_amount">Withdrawal Amount (J)</option>
              <option value="unique_player">Unique Player (K)</option>
              <option value="turnover">Turnover (N)</option>
              <option value="company_win_loss">Company Win/Loss (O)</option>
              <option value="bonus">Bonus (P)</option>
              <option value="net_loss">Net Loss (Q)</option>
            </select>
          </label>
        </div>
        <div class="row row-tight">
          <div class="toggle-wrap">
            <input type="checkbox" id="chkShowTable">
            <label for="chkShowTable" class="toggle-label">Show hour table</label>
          </div>
          <div class="toggle-wrap">
            <input type="checkbox" id="chkStacked">
            <label for="chkStacked" class="toggle-label">Stack brands</label>
          </div>
          <div class="toggle-wrap">
            <input type="checkbox" id="chkSmooth">
            <label for="chkSmooth" class="toggle-label">Smooth lines</label>
          </div>
        </div>
      </div>
      <div class="kpis card-lite" id="kpiBar"></div>
    </div>
    <div class="chart-area card-solid">
      <canvas id="chartHourlyCanvas"></canvas>
    </div>
    <div id="hourTableWrap" class="table-area card-solid" style="display:none;">
      <div class="table-scroll">
        <table class="hour-table" id="hourTable"></table>
      </div>
    </div>
  </div>
  <script>
/* ======================== CONFIG ======================== */
const groups = {
  'ðŸ“Š View Live Stats': ['ðŸš€ Brand Battle (Stats)'],
  'Competitor Brands': ['Top 1', 'Top 2', 'Top 3', 'Top 4', 'Top 5'],
  'Leaderboard': ['Today', 'Yesterday'],
  'Domain RealTime Info': ['Unreachable Domains', 'Crickex', 'BetJILI', 'Mostplay', 'S10', 'BetVisa', 'Jeetwin']
};
const highlightValues = [
  'BA JI','JEET BUZZ','CRICKEX','MCW','BET JILI','JEET WIN','MOSTPLAY','BET VISA',
  'SIX6S','KHELA GHOR','BANGLAWIN','BANGLABET88','JEET BANGLA','MXW','PB',
  'HEY BAJI','BANGLA SLOT','DARAZ PLAY','KHELO VIP','BENGAL BET','SUPER BAJI',
  'FANCY WIN','E28','OZWIN365','SLOT BAJI','BET JDB','BET NAGA','JW','JEET WAY','WKTS','BH'
];
const domainInfoSheets = ['Crickex', 'BetJILI', 'Mostplay', 'S10', 'BetVisa', 'Jeetwin'];
const sheetsToFreezeHeader = [
  'Today','Yesterday','Analysis Today','Analysis Yesterday',
  'Real Time Net Analysis','Real Time By Currency',
  'ðŸš€ Brand Battle (Stats)',
  'Unreachable Domains','Crickex','Mostplay','S10','BetVisa','Jeetwin'
];
/* ======================== STATE ======================== */
let currentSheet = null;
let currentSpreadsheetId = null;
let refreshInterval = null;
let currentData = null;
let currentHeader = null;
let sheetListCache = [];
let isAuthenticated = localStorage.getItem('isAuthenticated') === 'true';
/* ===== NetV2 UI state ===== */
const NETV2_UI = { overallOpen: JSON.parse(localStorage.getItem('NETV2_OVERALL_OPEN') || 'true') };
/* ===== Sort state ===== */
const TABLE_SORT = { col: null, dir: 'asc' };
/* ===== Search state ===== */
let NETV2_SEARCH = '';
/* ======================== UTIL ======================== */
function updateTimestamp() {
  const timestamp = document.getElementById('timestamp');
  const now = new Date();
  const options = {
    timeZone: 'Asia/Singapore',
    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
    hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true
  };
  const parts = new Intl.DateTimeFormat('en-US', options).formatToParts(now);
  const formatted = `${parts.find(p=>p.type==='weekday').value}, ${parts.find(p=>p.type==='month').value} ${parts.find(p=>p.type==='day').value}, ${parts.find(p=>p.type==='year').value} at ${parts.find(p=>p.type==='hour').value}:${parts.find(p=>p.type==='minute').value}:${parts.find(p=>p.type==='second').value} ${parts.find(p=>p.type==='dayPeriod').value}`;
  timestamp.innerHTML = `<span class="emoji">ðŸŽ‰</span> ${formatted}`;
}
function isValidUrl(str) { return typeof str === 'string' && str.startsWith('http'); }
function parseNumeric(value) {
  if (value == null) return null;
  if (typeof value === 'number') return isNaN(value) ? null : value;
  if (typeof value === 'string') {
    let v = value.trim();
    const paren = /^\((.*)\)$/.test(v); if (paren) v = v.replace(/^\(|\)$/g, '');
    v = v.replace(/,/g, '').replace(/%/g, '').trim();
    const num = parseFloat(v);
    if (isNaN(num)) return null;
    // Check if the entire cleaned string represents a valid number (regex for numeric string)
    if (/^-?(?:\d+(?:\.\d*)?|\.\d+)$/.test(v)) {
      return paren ? -num : num;
    }
    return null;
  }
  return null;
}
function formatPercent(raw, numeric) {
  if (numeric == null) return '';
  let v;
  if (typeof raw === 'string' && raw.includes('%')) {
    const cleaned = raw.replace(/,/g, '').replace('%','').trim();
    const parsed = parseFloat(cleaned);
    v = isNaN(parsed) ? numeric : parsed;
  } else if (Math.abs(numeric) <= 1) { v = numeric * 100; }
  else { v = numeric; }
  const out = v.toFixed(2) + '%';
  return v < 0 ? `<span class="percentage-negative">${out}</span>` : out;
}
/* signatures for silent refresh */
function rowsSignature(rows){
  try {
    if (!Array.isArray(rows)) return '0';
    const len = rows.length;
    const head = len ? JSON.stringify(rows[0]).length : 0;
    const tail = len ? JSON.stringify(rows[len-1]).length : 0;
    return `${len}:${head}:${tail}`;
  } catch(e){ return String(rows?.length||0); }
}
function objectSignature(obj){
  try { return JSON.stringify(obj).length.toString(); }
  catch(e){ return 'x'; }
}
/* ======================== MENUS/SIDEBAR ======================== */
function createTopMenu(sheetList) {
  const topMenu = document.getElementById('top-menu');
  topMenu.innerHTML = '';
  for (const [groupName, sheets] of Object.entries(groups)) {
    const groupDiv = document.createElement('div');
    groupDiv.className = 'top-menu-group';
    const header = document.createElement('button');
    header.textContent = groupName;
    header.className = 'top-menu-group-header';
    header.onclick = (e) => {
      e.preventDefault();
      const content = header.nextElementSibling;
      content.classList.toggle('open');
      header.classList.toggle('open');
    };
    const content = document.createElement('div');
    content.className = 'top-menu-group-content';
    sheets.forEach(sheet => {
      const info = sheetList.find(s => s.name === sheet);
      if (info) {
        const button = document.createElement('button');
        button.textContent = sheet;
        button.onclick = () => {
          loadSheet(info.name, info.spreadsheetId);
          document.querySelectorAll('#top-menu button').forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
        };
        content.appendChild(button);
      }
    });
    groupDiv.appendChild(header);
    groupDiv.appendChild(content);
    topMenu.appendChild(groupDiv);
  }
  // open first group by default
  if (topMenu.querySelector('.top-menu-group-header')) {
    const firstHeader = topMenu.querySelector('.top-menu-group-header');
    firstHeader.nextElementSibling.classList.add('open');
    firstHeader.classList.add('open');
    const firstBtn = firstHeader.nextElementSibling.querySelector('button');
    if (firstBtn) {
      firstBtn.classList.add('active');
      const info = sheetList.find(s => s.name === firstBtn.textContent);
      if (info) loadSheet(info.name, info.spreadsheetId);
    }
  }
}
function createSidebar(sheetList) {
  const sidebarContent = document.getElementById('sidebar-content');
  sidebarContent.innerHTML = '';
  for (const [group, sheets] of Object.entries(groups)) {
    const div = document.createElement('div');
    div.className = 'group';
    const header = document.createElement('h3');
    header.textContent = group;
    header.onclick = () => {
      const list = header.nextElementSibling;
      list.style.display = list.style.display === 'none' ? 'block' : 'none';
      header.classList.toggle('open');
    };
    const ul = document.createElement('ul');
    ul.className = 'sheet-list';
    sheets.forEach(name => {
      const info = sheetList.find(s => s.name === name);
      if (info) {
        const li = document.createElement('li');
        li.textContent = name;
        li.onclick = (e) => {
          e.stopPropagation();
          loadSheet(info.name, info.spreadsheetId);
          toggleSidebar();
        };
        ul.appendChild(li);
      }
    });
    div.appendChild(header);
    div.appendChild(ul);
    sidebarContent.appendChild(div);
  }
}
/* ======================== FORMATTER ======================== */
function formatValue(value, columnHeader, row, rowIndex, colIndex) {
  if ((currentSheet === 'ðŸš€ Brand Battle (Stats)' || currentSheet === 'Net Net AnalysisV2') &&
      (colIndex === 5 || colIndex === 11)) {
    return value == null ? '' : String(value); // keep Sheets formatting
  }
  const numericValue = parseNumeric(value);
  const isCompetitorSheet = groups['Competitor Brands'].includes(currentSheet);
  if (isCompetitorSheet && columnHeader && /different/i.test(columnHeader) && numericValue !== null) {
    const formatted = Math.round(numericValue).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    return numericValue < 0 ? `<span class="numeric-negative">${formatted}</span>` : formatted;
  }
  if (['Today','Yesterday'].includes(currentSheet)) {
    if ([2,4,6,9,11].includes(colIndex) && numericValue !== null) {
      return Math.round(numericValue).toLocaleString('en-US',{ minimumFractionDigits:0, maximumFractionDigits:0 });
    }
  }
  if (['Analysis Today','Analysis Yesterday'].includes(currentSheet)) {
    if ([4,5,6,8,10,11].includes(colIndex) && numericValue !== null) {
      return Math.round(numericValue).toLocaleString('en-US',{ minimumFractionDigits:0, maximumFractionDigits:0 });
    }
    if (colIndex === 1 && typeof value === 'string') {
      const date = new Date(value);
      return isNaN(date) ? value : date.toISOString().split('T')[0];
    }
    if (colIndex === 2 && numericValue !== null) {
      if (numericValue >= 0 && numericValue <= 23) {
        const hour = numericValue.toString().padStart(2,'0');
        return `${hour}:00 ${numericValue < 12 ? 'AM' : 'PM'}`;
      }
    }
    if (colIndex === 17 && numericValue !== null) return formatPercent(value, numericValue);
  }
  if (currentSheet === 'Real Time Net Analysis') {
    if (colIndex === 1 && numericValue !== null) {
      return Math.round(numericValue).toLocaleString('en-US',{ minimumFractionDigits:0, maximumFractionDigits:0 });
    }
    if ([5,11].includes(colIndex) && numericValue !== null) return formatPercent(value, numericValue);
  }
  if (groups['Domain RealTime Info'].includes(currentSheet)) {
    if (colIndex === 3 && typeof value === 'string') {
      const date = new Date(value);
      return isNaN(date) ? value : date.toLocaleString('en-US', { dateStyle:'medium', timeStyle:'short' });
    }
    if (colIndex === 2 && isValidUrl(value)) {
      return `<a class="link-view" href="${value}" onclick="window.location.href='${value}'; return false;">View Link</a>`;
    }
    if (colIndex === 5 && typeof value === 'string') {
      if (value.includes('%ERROR%')) return `<span style="color:#cf2525; font-weight:bold;">${value}</span>`;
    }
  }
  if (domainInfoSheets.includes(currentSheet)) {
    if (colIndex === 2 && isValidUrl(value)) {
      return `<a class="link-view" href="${value}" onclick="window.location.href='${value}'; return false;">View Link</a>`;
    }
    if ([3,6,9,12].includes(colIndex) && typeof value === 'string') {
      const date = new Date(value);
      return isNaN(date) ? value : date.toLocaleString('en-US', { dateStyle:'medium', timeStyle:'short' });
    }
  }
  if (isCompetitorSheet && [1,3,5,8,10].includes(colIndex) && numericValue !== null) {
    const formatted = Math.round(numericValue).toLocaleString('en-US',{ minimumFractionDigits:0, maximumFractionDigits:0 });
    return numericValue < 0 ? `<span class="numeric-negative">${formatted}</span>` : `<span class="accounting-format">${formatted}</span>`;
  }
  if (currentSheet === 'Real Time By Currency' && colIndex === 4 && numericValue !== null) {
    return formatPercent(value, numericValue);
  }
  if (columnHeader === 'Rank' && numericValue !== null) return Math.floor(numericValue);
  if (domainInfoSheets.includes(currentSheet) && [4,7,10,13].includes(colIndex)) {
    if (typeof value === 'string') {
      if (value.includes('OK')) return `<span class="ok-text">OK</span>`;
      if (value.includes('ERROR:')) return `<span class="error-text">${value}</span>`;
    }
  }
  if ((groups['Competitor Brands'].includes(currentSheet) || ['Today','Yesterday'].includes(currentSheet)) &&
      columnHeader && /different/i.test(columnHeader) && numericValue !== null) {
    const absFmt = Math.round(Math.abs(numericValue)).toLocaleString(undefined,{ minimumFractionDigits:0, maximumFractionDigits:0 });
    return numericValue < 0 ? `<span class="numeric-negative">-${absFmt}</span>` : absFmt;
  }
  if (numericValue !== null) {
    const formatted = Math.round(numericValue).toLocaleString(undefined,{ minimumFractionDigits: 0, maximumFractionDigits: 0 });
    return numericValue < 0 ? `<span class="numeric-negative">${formatted}</span>` : formatted;
  }
  if (typeof value === 'string') {
    const lower = value.toLowerCase();
    if (lower === 'good') return '<span class="status-good">Good</span>';
    if (lower === 'medium') return '<span class="status-medium">Medium</span>';
    if (lower === 'bad') return '<span class="status-bad">Bad</span>';
    if (isValidUrl(value)) {
      if (value.match(/\.(jpg|jpeg|png|gif|webp)$/i)) return `<a class="link-view" onclick="showImage('${value}')">View Screenshot</a>`;
      return `<a class="link-view" href="${value}" onclick="window.location.href='${value}'; return false;">View Link</a>`;
    }
  }
  return value || '';
}
/* ======================== SORT & SEARCH HELPERS ======================== */
function compareCells(a, b) {
  const na = parseNumeric(a), nb = parseNumeric(b);
  if (na !== null && nb !== null) {
    if (na < nb) return -1;
    if (na > nb) return 1;
    return 0;
  }
  const sa = String(a ?? '').toLowerCase();
  const sb = String(b ?? '').toLowerCase();
  if (sa < sb) return -1;
  if (sa > sb) return 1;
  return 0;
}
function sortRows(rows, colIdx, dir='asc') {
  if (colIdx == null) return rows.slice();
  const sorted = rows.slice().sort((r1, r2) => compareCells(r1[colIdx], r2[colIdx]));
  return (dir === 'desc') ? sorted.reverse() : sorted;
}
function applySearchRows(rows, query) {
  const q = (query || '').trim().toLowerCase();
  if (!q) return rows;
  return rows.filter(r => r.some(c => String(c ?? '').toLowerCase().includes(q)));
}
/* ======================== RENDER TABLE ======================== */
function renderTable(header, data, isInitial = true) {
  const container = document.getElementById('table-container');
  currentHeader = header;
  currentData = data;
  if (isInitial) {
    container.innerHTML = '';
    const table = document.createElement('table');
    if (groups['Domain RealTime Info'].includes(currentSheet)) {
      table.classList.add('domain-realtime');
    }
    // Head
    const thead = document.createElement('thead');
    const trHead = document.createElement('tr');
    header.forEach((h, idx) => {
      const th = document.createElement('th');
      th.textContent = h || '';
      th.classList.add('sticky-header'); /* Always freeze header */
      if (idx === 0) {
        th.classList.add('sticky-left'); /* Freeze first column header */
        th.classList.add('sticky-corner'); /* For corner */
      }
      if (TABLE_SORT.col === idx) {
        const caret = document.createElement('span');
        caret.className = 'sort-caret';
        caret.textContent = (TABLE_SORT.dir === 'asc') ? 'â–²' : 'â–¼';
        th.appendChild(caret);
      }
      if (currentSheet === 'ðŸš€ Brand Battle (Stats)' || currentSheet === 'Net Net AnalysisV2') {
        th.style.cursor = 'pointer';
        th.title = 'Click to sort';
        th.onclick = () => {
          if (TABLE_SORT.col === idx) {
            TABLE_SORT.dir = (TABLE_SORT.dir === 'asc') ? 'desc' : 'asc';
          } else {
            TABLE_SORT.col = idx;
            TABLE_SORT.dir = 'asc';
          }
          withPreservedScroll(() => {
            applyNetV2Filter(false);
          });
        };
      }
      trHead.appendChild(th);
    });
    thead.appendChild(trHead);
    table.appendChild(thead);
    // Body
    const tbody = document.createElement('tbody');
    data.forEach((row, rowIndex) => {
      const tr = document.createElement('tr');
      tr.dataset.row = rowIndex;
      tr.style.opacity = '0';
      tr.style.animation = 'fadeIn 0.5s ease-in-out forwards';
      tr.style.animationDelay = `${rowIndex * 0.02}s`;
      const firstCell = String(row[0]).toUpperCase().trim();
      const isHighlight = groups['Competitor Brands'].includes(currentSheet) &&
                          row[0] && highlightValues.some(val => val.toUpperCase().trim() === firstCell);
      if (isHighlight) tr.classList.add('highlight-row');
      if (header.includes('Rank')) {
        const rankIndex = header.indexOf('Rank');
        const rank = parseNumeric(row[rankIndex]);
        if (rank !== null) {
          if (rank === 1) tr.classList.add('rank-top-1');
          else if (rank === 2) tr.classList.add('rank-top-2');
          else if (rank === 3) tr.classList.add('rank-top-3');
          else if (rank === 4) tr.classList.add('rank-top-4');
          else if (rank === 5) tr.classList.add('rank-top-5');
        }
      }
      row.forEach((cell, colIndex) => {
        const td = document.createElement('td');
        td.dataset.col = colIndex;
        td.innerHTML = isHighlight ? (cell || '') : formatValue(cell, header[colIndex], row, rowIndex, colIndex);
        if (colIndex === 0) td.classList.add('sticky-left'); /* Always freeze first column */
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    container.appendChild(table);
    document.getElementById('loadingOverlay').style.display = 'none';
    return;
  }
  // Incremental update (silent)
  const tbody = container.querySelector('tbody');
  if (!tbody) return;
  const existingRows = Array.from(tbody.querySelectorAll('tr'));
  data.forEach((row, rowIndex) => {
    let tr = existingRows[rowIndex] || document.createElement('tr');
    if (!existingRows[rowIndex]) {
      tr.dataset.row = rowIndex;
      tr.style.opacity = '0';
      tr.style.animation = 'fadeIn 0.5s ease-in-out forwards';
      tbody.appendChild(tr);
    }
    const firstCell = String(row[0]).toUpperCase().trim();
    const isHighlight = groups['Competitor Brands'].includes(currentSheet) &&
                        row[0] && highlightValues.some(val => val.toUpperCase().trim() === firstCell);
    tr.classList.remove('highlight-row','rank-top-1','rank-top-2','rank-top-3','rank-top-4','rank-top-5');
    if (isHighlight) tr.classList.add('highlight-row');
    if (header.includes('Rank')) {
      const rankIndex = header.indexOf('Rank');
      const rank = parseNumeric(row[rankIndex]);
      if (rank !== null) {
        if (rank === 1) tr.classList.add('rank-top-1');
        else if (rank === 2) tr.classList.add('rank-top-2');
        else if (rank === 3) tr.classList.add('rank-top-3');
        else if (rank === 4) tr.classList.add('rank-top-4');
        else if (rank === 5) tr.classList.add('rank-top-5');
      }
    }
    row.forEach((cell, colIndex) => {
      let td = tr.querySelector(`td[data-col="${colIndex}"]`);
      if (!td) {
        td = document.createElement('td');
        td.dataset.col = colIndex;
        if (colIndex === 0) td.classList.add('sticky-left'); /* Always freeze first column */
        tr.appendChild(td);
      }
      const newValue = isHighlight ? (cell || '') : formatValue(cell, header[colIndex], row, rowIndex, colIndex);
      if (td.innerHTML !== newValue) td.innerHTML = newValue;
    });
  });
  if (existingRows.length > data.length) {
    for (let i = data.length; i < existingRows.length; i++) tbody.removeChild(existingRows[i]);
  }
  const ths = container.querySelectorAll('thead th');
  ths.forEach((th, idx) => {
    const c = th.querySelector('.sort-caret');
    if (c) c.remove();
    if (TABLE_SORT.col === idx) {
      const caret = document.createElement('span');
      caret.className = 'sort-caret';
      caret.textContent = (TABLE_SORT.dir === 'asc') ? 'â–²' : 'â–¼';
      th.appendChild(caret);
    }
  });
}
/* ======================== SCROLL PRESERVER ======================== */
function withPreservedScroll(fn){
  const cont = document.getElementById('table-container');
  if (!cont) { fn(); return; }
  const st = cont.scrollTop, sl = cont.scrollLeft;
  fn();
  cont.scrollTop = st; cont.scrollLeft = sl;
}
/* ======================== DEBOUNCE ======================== */
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => { clearTimeout(timeout); func(...args); };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}
/* ======================== LOADERS ======================== */
const loadSheetDebounced = debounce((sheetName, spreadsheetId) => {
  if (!isAuthenticated) { document.getElementById('login-container').style.display = 'block'; return; }
  if (currentSheet !== sheetName || currentSpreadsheetId !== spreadsheetId) {
    document.getElementById('loadingOverlay').style.display = 'flex';
  }
  currentSheet = sheetName;
  currentSpreadsheetId = spreadsheetId;
  google.script.run
    .withSuccessHandler(function(result) {
      if (!result) {
        document.getElementById('table-container').innerHTML = `<p style="color:#f87171">No response from server. Check execution logs.</p>`;
      } else if (result.error) {
        document.getElementById('table-container').innerHTML = `<p style="color:#f87171">${result.error}</p>`;
      } else if (!result.data || result.data.length === 0) {
        document.getElementById('table-container').innerHTML = `<p style="color:#f87171">No data available for "${currentSheet}".</p>`;
      } else {
        if (['Today','Yesterday','Analysis Today','Analysis Yesterday'].includes(currentSheet) && result.header.includes('Rank')) {
          result.data.sort((a,b) => {
            const rankA = parseFloat(a[result.header.indexOf('Rank')]) || Infinity;
            const rankB = parseFloat(b[result.header.indexOf('Rank')]) || Infinity;
            return rankA - rankB;
          });
        }
        if (sheetName === 'ðŸš€ Brand Battle (Stats)' || sheetName === 'Net Net AnalysisV2') {
          (async () => {
            TABLE_SORT.col = 2;
            TABLE_SORT.dir = 'desc';
            await buildNetV2Controls(result.header, result.data || []);
            applyNetV2Filter(true);
            await ensureOverallLoaded();
            renderNetV2Overall();
            document.getElementById('netv2-searchwrap').style.display = 'flex';
            document.getElementById('table-tools').style.display = 'flex';
            await refreshUpdateTime(true);
          })();
          document.getElementById('netv2-overall').style.display = 'block';
        } else {
          const ctl = document.getElementById('netv2-controls');
          if (ctl) ctl.style.display = 'none';
          const overall = document.getElementById('netv2-overall');
          if (overall) overall.style.display = 'none';
          document.getElementById('netv2-searchwrap').style.display = 'none';
          document.getElementById('table-tools').style.display = 'none';
          TABLE_SORT.col = null; TABLE_SORT.dir = 'asc';
          NETV2_SEARCH = '';
          renderTable(result.header, result.data, true);
        }
      }
      document.getElementById('loadingOverlay').style.display = 'none';
    })
    .withFailureHandler(function(err) {
      document.getElementById('table-container').innerHTML = `<p style="color:#f87171">Failed to load data: ${err.message}</p>`;
      document.getElementById('loadingOverlay').style.display = 'none';
    })
    .getSheetData(sheetName, spreadsheetId);
}, 500);
function loadSheet(sheetName, spreadsheetId) {
  if (refreshInterval) clearInterval(refreshInterval);
  loadSheetDebounced(sheetName, spreadsheetId);
  refreshInterval = setInterval(() => {
    google.script.run
      .withSuccessHandler(function(result) {
        if (!result || result.error) return;
        if (['Today','Yesterday','Analysis Today','Analysis Yesterday'].includes(currentSheet) && result.header.includes('Rank')) {
          result.data.sort((a,b) => {
            const rankA = parseFloat(a[result.header.indexOf('Rank')]) || Infinity;
            const rankB = parseFloat(b[result.header.indexOf('Rank')]) || Infinity;
            return rankA - rankB;
          });
        }
        if (currentSheet === 'ðŸš€ Brand Battle (Stats)' || currentSheet === 'Net Net AnalysisV2') {
          const newSig = rowsSignature(result.data||[]);
          if (NETV2.sig !== newSig) {
            NETV2.sig = newSig;
            NETV2.header = result.header;
            NETV2.raw = result.data || [];
            withPreservedScroll(() => applyNetV2Filter(false));
          }
          refreshOverallIfNeeded();
          refreshUpdateTime(false);
        } else {
          const newSig = rowsSignature(result.data||[]);
          if (window.__lastSheetSig !== newSig) {
            window.__lastSheetSig = newSig;
            withPreservedScroll(() => renderTable(result.header, result.data, false));
          }
        }
      })
      .withFailureHandler(function(err) { console.error('Refresh failed:', err); })
      .getSheetData(sheetName, spreadsheetId);
  }, 5000);
}
/* ======================== IMAGE MODAL ======================== */
function showImage(url) {
  const modal = document.getElementById('imgModal');
  const modalImg = document.getElementById('modalImage');
  if (!modal || !modalImg) return;
  modalImg.src = url;
  modal.style.display = 'block';
}
function closeModal() { const modal = document.getElementById('imgModal'); if (modal) modal.style.display = 'none'; }
/* ======================== UI MISC ======================== */
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  sidebar.classList.toggle('active');
  if (window.innerWidth <= 768) {
    sidebar.classList.toggle('fullscreen');
    const backdrop = document.querySelector('.sidebar-backdrop');
    backdrop.style.display = sidebar.classList.contains('fullscreen') ? 'block' : 'none';
  }
}
/* ====== AUTH: LOGIN / LOGOUT ====== */
function login() {
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;
  const validUsers = { 'admin': '11a', 'cx2025': '123qwe' };
  if (validUsers[username] === password) {
    isAuthenticated = true;
    localStorage.setItem('isAuthenticated','true');
    // Show secure UI only after successful auth
    document.body.classList.add('auth');
    document.getElementById('login-container').style.display = 'none';
    document.getElementById('logout-btn').style.display = 'block';
    // Start timestamp
    if (window.__tsInt) clearInterval(window.__tsInt);
    updateTimestamp();
    window.__tsInt = setInterval(updateTimestamp, 1000);
    // Load menus only after auth
    google.script.run.withSuccessHandler(function(sheetList) {
      sheetListCache = sheetList || [];
      createTopMenu(sheetList);
      createSidebar(sheetList);
      initHourlyChart();
    }).getSheetList();
  } else {
    alert('Invalid username or password');
  }
}
function logout() {
  isAuthenticated = false;
  localStorage.removeItem('isAuthenticated');
  // Stop timers/refresh
  if (refreshInterval) { clearInterval(refreshInterval); refreshInterval = null; }
  if (window.__tsInt) { clearInterval(window.__tsInt); window.__tsInt = null; }
  // Close/destroy chart if open
  try { if (CHART_STATE?.chart) { CHART_STATE.chart.destroy(); CHART_STATE.chart = null; } } catch(e){}
  const m = document.getElementById('chartModal'); if (m) m.classList.remove('show');
  const b = document.getElementById('chartBackdrop'); if (b) b.classList.remove('show');
  // Clear UI + data so nothing remains
  const clearEl = id => { const el = document.getElementById(id); if (el) el.innerHTML = ''; };
  clearEl('top-menu');
  clearEl('sidebar-content');
  clearEl('table-container');
  const badge = document.getElementById('updateTimeBadge'); if (badge) badge.textContent = 'Update Time : â€”';
  const ctl = document.getElementById('netv2-controls'); if (ctl) ctl.style.display = 'none';
  const overall = document.getElementById('netv2-overall'); if (overall) overall.style.display = 'none';
  const searchwrap = document.getElementById('netv2-searchwrap'); if (searchwrap) searchwrap.style.display = 'none';
  // Reset state
  currentSheet = null; currentSpreadsheetId = null;
  currentData = null; currentHeader = null; sheetListCache = [];
  NETV2.header = null; NETV2.raw = []; NETV2.overallMap = null; NETV2.sig = null; NETV2.overallSig = null; NETV2.updateTimeSig = '';
  // Hide secure UI, show login only
  document.body.classList.remove('auth');
  document.getElementById('logout-btn').style.display = 'none';
  document.getElementById('login-container').style.display = 'block';
  // Clear username and password fields
  document.getElementById('username').value = '';
  document.getElementById('password').value = '';
  // Safety scroll to top
  window.scrollTo({ top: 0 });
}
document.getElementById('toggle-nav').onclick = toggleSidebar;
window.onclick = function(event) {
  const modal = document.getElementById('imgModal');
  const sidebar = document.getElementById('sidebar');
  const toggleBtn = document.getElementById('toggle-nav');
  if (event.target === modal) modal.style.display = 'none';
  if (!sidebar.contains(event.target) && event.target !== toggleBtn && sidebar.classList.contains('active')) toggleSidebar();
};
/* ===== Initial auth gate on load (no flicker) ===== */
(function initAuthGate(){
  if (!isAuthenticated) {
    // Not logged in: show only login, hide logout
    document.body.classList.remove('auth');
    document.getElementById('login-container').style.display = 'block';
    document.getElementById('logout-btn').style.display = 'none';
    // Clear fields on initial load if not authenticated
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
  } else {
    // Already logged in previously: add .auth first to prevent flicker, then load
    document.body.classList.add('auth');
    document.getElementById('login-container').style.display = 'none';
    document.getElementById('logout-btn').style.display = 'block';
    if (!window.__tsInt) { updateTimestamp(); window.__tsInt = setInterval(updateTimestamp, 1000); }
    google.script.run.withSuccessHandler(function(sheetList) {
      sheetListCache = sheetList || [];
      createTopMenu(sheetList);
      createSidebar(sheetList);
      initHourlyChart();
    }).getSheetList();
  }
})();
/* ======================== HOURLY CHART ======================== */
const ANALYSIS_COLS = {
  brand: 0, date: 1, hour: 2,
  registered_count: 4, first_deposit_count: 5, deposit_count: 6, deposit_amount: 7,
  withdrawal_count: 8, withdrawal_amount: 9, unique_player: 10,
  turnover: 13, company_win_loss: 14, bonus: 15, net_loss: 16
};
const CHART_STATE = { day:'Analysis Today', brand:'ALL', metric:'registered_count', dataToday:null, dataYday:null, chart:null };
function findSheetMetaByName(name){ return (sheetListCache||[]).find(s=>s.name===name)||null; }
function getSheetDataPromise(sheetName, spreadsheetId){
  return new Promise((resolve,reject)=>{
    google.script.run.withSuccessHandler(res=>resolve(res)).withFailureHandler(err=>reject(err)).getSheetData(sheetName, spreadsheetId);
  });
}
async function loadAnalysisSheets(){
  const metaToday = findSheetMetaByName('Analysis Today');
  const metaYday = findSheetMetaByName('Analysis Yesterday');
  if (!metaToday || !metaYday) return { today:null, yday:null };
  const [todayRes, ydayRes] = await Promise.all([
    getSheetDataPromise(metaToday.name, metaToday.spreadsheetId),
    getSheetDataPromise(metaYday.name, metaYday.spreadsheetId)
  ]);
  return {
    today: (todayRes && !todayRes.error) ? todayRes.data||[] : [],
    yday: (ydayRes && !ydayRes.error) ? ydayRes.data||[] : []
  };
}
function buildHourlySeries(rows, brand, metricKey){
  const allBrands = Array.from(new Set(rows.map(r => (r?.[ANALYSIS_COLS.brand] ?? '')).map(s=>String(s).trim()).filter(Boolean))).sort();
  const brands = brand==='ALL' ? allBrands : [brand];
  const labels = Array.from({length:24}, (_,h) => `${String(h).padStart(2,'0')}:00 ${h<12?'AM':'PM'}`);
  const datasets = brands.map(b => {
    const filtered = rows.filter(r => String(r?.[ANALYSIS_COLS.brand] ?? '').trim() === b);
    const buckets = Array.from({length:24}, () => 0);
    for (const r of filtered) {
      const hRaw = r?.[ANALYSIS_COLS.hour];
      const h = typeof hRaw === 'number' ? hRaw : parseInt(String(hRaw).trim(), 10);
      if (!Number.isFinite(h) || h<0 || h>23) continue;
      const rawVal = r?.[ANALYSIS_COLS[metricKey]];
      const val = parseNumeric(rawVal);
      if (val == null) continue;
      buckets[h] += val;
    }
    return { label:b, data:buckets, tension:0.35, pointRadius:3, pointHoverRadius:5, borderWidth:2, fill:false };
  });
  return { labels, datasets };
}
function metricPretty(key){
  return ({
    registered_count:'Registered Count', first_deposit_count:'First Deposit Count', deposit_count:'Deposit Count',
    deposit_amount:'Deposit Amount', withdrawal_count:'Withdrawal Count', withdrawal_amount:'Withdrawal Amount',
    unique_player:'Unique Player', turnover:'Turnover', company_win_loss:'Company Win/Loss', bonus:'Bonus', net_loss:'Net Loss'
  })[key] || key;
}
function ensureHourlyChart(ctx, cfg, reuse){
  const stacked = document.getElementById('chkStacked')?.checked ?? false;
  const smooth = document.getElementById('chkSmooth')?.checked ?? false;
  const datasets = cfg.datasets.map(d => ({ ...d, tension: smooth ? 0.35 : 0, fill: stacked ? true : false }));
  const options = {
    responsive:true, maintainAspectRatio:false, animation:false, interaction:{ mode:'index', intersect:false },
    plugins:{ title:{ display:true, text:cfg.title }, legend:{ display: datasets.length>1 } },
    scales:{ x:{ grid:{ display:true, drawBorder:true, borderWidth:1 } }, y:{ beginAtZero:true, grid:{ display:true, drawBorder:true, borderWidth:1 } } }
  };
  if (reuse) {
    reuse.data.labels = cfg.labels;
    reuse.data.datasets = datasets;
    reuse.options.plugins.title.text = cfg.title;
    reuse.options.plugins.legend.display = datasets.length>1;
    reuse.options.scales.x.stacked = stacked;
    reuse.options.scales.y.stacked = stacked;
    reuse.update();
    return reuse;
  }
  return new Chart(ctx, {
    type:'line',
    data:{ labels:cfg.labels, datasets },
    options:{ ...options, scales:{ ...options.scales, x:{ ...options.scales.x, stacked }, y:{ ...options.scales.y, stacked } } }
  });
}
function sum(arr){ return arr.reduce((a,b)=>a+b,0); }
function avg(arr){ return arr.length ? sum(arr)/arr.length : 0; }
function toHrLabel(i){ const h=Number(i)||0; return `${String(h).padStart(2,'0')}:00 ${h<12?'AM':'PM'}`; }
function computeStats(labels, datasets){
  const byHour = labels.map((_,idx)=>sum(datasets.map(ds=>Number(ds.data[idx]||0))));
  const total = sum(byHour), average = avg(byHour);
  let minVal = Infinity, minIdx = 0, maxVal = -Infinity, maxIdx = 0;
  byHour.forEach((v,i)=>{ if (v<minVal) {minVal=v; minIdx=i;} if (v>maxVal) {maxVal=v; maxIdx=i;} });
  return { total, average, minHour: toHrLabel(minIdx), minVal, maxHour: toHrLabel(maxIdx), maxVal, points: byHour.filter(v=>Number.isFinite(v)).length };
}
function formatNum(n){ return Number(n).toLocaleString(); }
function updateKpis(labels, datasets){
  const kpiWrap = document.getElementById('kpiBar'); if (!kpiWrap) return;
  const s = computeStats(labels, datasets);
  kpiWrap.innerHTML = `
    <div class="kpi"><div class="label">Total</div><div class="value">${formatNum(s.total)}</div><div class="sub">Sum of all hours</div></div>
    <div class="kpi"><div class="label">Avg / Hour</div><div class="value">${formatNum(Math.round(s.average))}</div><div class="sub">24-hour average</div></div>
    <div class="kpi"><div class="label">Peak</div><div class="value">${formatNum(s.maxVal)}</div><div class="sub">${s.maxHour}</div></div>
    <div class="kpi"><div class="label">Low</div><div class="value">${formatNum(s.minVal)}</div><div class="sub">${s.minHour}</div></div>
    <div class="kpi"><div class="label">Data Points</div><div class="value">${formatNum(s.points)}</div><div class="sub">non-empty hours</div></div>`;
}
function renderHourTable(labels, datasets){
  const wrap = document.getElementById('hourTableWrap');
  const tbl = document.getElementById('hourTable');
  if (!wrap || !tbl) return;
  const show = document.getElementById('chkShowTable')?.checked ?? false;
  wrap.style.display = show ? 'block' : 'none';
  if (!show) return;
  const headers = ['Hour', ...datasets.map(d => d.label), 'Total'];
  let html = '<thead><tr>' + headers.map(h=>`<th>${h}</th>`).join('') + '</tr></thead>';
  html += '<tbody>';
  for (let i=0; i<labels.length; i++){
    const rowVals = datasets.map(d => Number(d.data[i]||0));
    const total = sum(rowVals);
    html += `<tr><td>${labels[i]}</td>` + rowVals.map(v=>`<td>${formatNum(v)}</td>`).join('') + `<td>${formatNum(total)}</td></tr>`;
  }
  html += '</tbody>';
  tbl.innerHTML = html;
}
function exportCsv(labels, datasets, title){
  const headers = ['Hour', ...datasets.map(d=>d.label), 'Total'];
  const rows = [headers.join(',')];
  for (let i=0;i<labels.length;i++){
    const rowVals = datasets.map(d=>Number(d.data[i]||0));
    const total = sum(rowVals);
    rows.push([labels[i], ...rowVals, total].join(','));
  }
  const blob = new Blob([`"${title.replaceAll('"','""')}"\n` + rows.join('\n')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `hourly-${Date.now()}.csv`; a.click();
  URL.revokeObjectURL(url);
}
function populateBrandDropdown(allRows){
  const sel = document.getElementById('chartFilterBrand');
  sel.innerHTML = '<option value="ALL">All Brands</option>';
  const brands = Array.from(new Set(allRows.map(r => (r?.[ANALYSIS_COLS.brand] ?? '')).map(s=>String(s).trim()).filter(Boolean))).sort();
  for (const b of brands) { const opt = document.createElement('option'); opt.value=b; opt.textContent=b; sel.appendChild(opt); }
}
function refreshHourlyChart(){
  const canvas = document.getElementById('chartHourlyCanvas'); if (!canvas) return;
  const rows = (CHART_STATE.day==='Analysis Today') ? (CHART_STATE.dataToday||[]) : (CHART_STATE.dataYday||[]);
  const { labels, datasets } = buildHourlySeries(rows, CHART_STATE.brand, CHART_STATE.metric);
  const title = `${metricPretty(CHART_STATE.metric)} â€¢ ${CHART_STATE.brand === 'ALL' ? 'All Brands' : CHART_STATE.brand} â€¢ ${CHART_STATE.day}`;
  CHART_STATE.chart = ensureHourlyChart(canvas.getContext('2d'), { labels, datasets, title }, CHART_STATE.chart);
  updateKpis(labels, datasets);
  renderHourTable(labels, datasets);
  const btnCsv = document.getElementById('btnExportCsv');
  if (btnCsv) btnCsv.onclick = () => exportCsv(labels, datasets, title);
}
async function initHourlyChart(){
  const openBtn = document.getElementById('btnHourlyChart');
  const backdrop= document.getElementById('chartBackdrop');
  const modal = document.getElementById('chartModal');
  const closeBtn= document.getElementById('btnChartClose');
  const selDay = document.getElementById('chartFilterDay');
  const selBrand= document.getElementById('chartFilterBrand');
  const selMetric=document.getElementById('chartFilterMetric');
  if (!openBtn || !modal) return;
  let loaded = false;
  function openModal() {
    modal.classList.add('show'); backdrop.classList.add('show');
    (async () => {
      if (!loaded) {
        document.getElementById('loadingOverlay').style.display = 'flex';
        try {
          const { today, yday } = await loadAnalysisSheets();
          CHART_STATE.dataToday = today||[]; CHART_STATE.dataYday = yday||[];
          populateBrandDropdown([...(CHART_STATE.dataToday||[]), ...(CHART_STATE.dataYday||[])]);
          loaded = true;
        } catch(e) { console.error('Failed to load analysis sheets', e); alert('Failed to load Analysis sheets.'); }
        finally { document.getElementById('loadingOverlay').style.display = 'none'; }
      }
      refreshHourlyChart();
    })();
  }
  function closeModal(){
    modal.classList.remove('show');
    backdrop.classList.remove('show');
  }
  openBtn.addEventListener('click', openModal);
  closeBtn.addEventListener('click', closeModal);
  backdrop.addEventListener('click', closeModal);
  document.addEventListener('keydown', (e)=>{ if (e.key==='Escape') closeModal(); });
  [selDay, selBrand, selMetric].forEach(sel => {
    sel.addEventListener('change', () => {
      CHART_STATE.day = selDay.value; CHART_STATE.brand = selBrand.value; CHART_STATE.metric = selMetric.value;
      refreshHourlyChart();
    });
  });
  const chkShowTable = document.getElementById('chkShowTable');
  const chkStacked = document.getElementById('chkStacked');
  const chkSmooth = document.getElementById('chkSmooth');
  [chkShowTable,chkStacked,chkSmooth].forEach(el => { if (el) el.addEventListener('change', () => refreshHourlyChart()); });
}
/* ======================== Net Net AnalysisV2 ======================== */
const NETV2 = { segment:'CX', currency:'ALL', header:null, raw:[], currencyMap:null, overallMap:null, sig:null, overallSig:null, updateTimeSig:'' };
const _norm = s => String(s||'').toLowerCase().replace(/[^a-z0-9]/g,'');
function findCol(header, candidates){
  const H = header.map(h => _norm(h));
  for (const c of candidates) {
    const i = H.findIndex(h => h === _norm(c));
    if (i !== -1) return i;
  }
  if (candidates.some(c => _norm(c).includes('currency'))) {
    const i = H.findIndex(h => h.includes('curren'));
    if (i !== -1) return i;
  }
  if (candidates.some(c => ['call','section','segment','group'].includes(_norm(c)))) {
    const i = H.findIndex(h => h.includes('call') || h.includes('segment') || h.includes('section') || h.includes('group'));
    if (i !== -1) return i;
  }
  return -1;
}
function segMatch(selected, value){
  const v = String(value||'').trim().toUpperCase();
  if (selected === 'ALL') return true;
  if (selected === 'MCW') return v === 'MCW' || v === 'MCX';
  return v === selected;
}
/* --- currency list from server --- */
function loadNetV2CurrencyMap() {
  return new Promise((resolve) => {
    if (NETV2.currencyMap) return resolve(NETV2.currencyMap);
    google.script.run
      .withSuccessHandler(function(res){
        NETV2.currencyMap = (res && !res.error) ? res : {CX:[],MCW:[],BAJI:[]};
        resolve(NETV2.currencyMap);
      })
      .withFailureHandler(function(err){
        console.error('getNetV2Currencies failed:', err);
        NETV2.currencyMap = {CX:[],MCW:[],BAJI:[]};
        resolve(NETV2.currencyMap);
      })
      .getNetV2Currencies();
  });
}
/* --- overall map loader --- */
async function ensureOverallLoaded(){
  if (NETV2.overallMap) return NETV2.overallMap;
  return new Promise((resolve)=>{
    google.script.run
      .withSuccessHandler(function(res){
        NETV2.overallMap = (res && !res.error) ? res : {CX:{header:[],rows:[]}, MCW:{header:[],rows:[]}, BAJI:{header:[],rows:[]}};
        NETV2.overallSig = objectSignature(NETV2.overallMap);
        resolve(NETV2.overallMap);
      })
      .withFailureHandler(function(err){
        console.error('getNetV2Overall failed:', err);
        NETV2.overallMap = {CX:{header:[],rows:[]}, MCW:{header:[],rows:[]}, BAJI:{header:[],rows:[]}};
        NETV2.overallSig = objectSignature(NETV2.overallMap);
        resolve(NETV2.overallMap);
      })
      .getNetV2Overall();
  });
}
/* quiet poll for Overall; update only if changed */
function refreshOverallIfNeeded(){
  google.script.run
    .withSuccessHandler(function(res){
      if (!res || res.error) return;
      const sig = objectSignature(res);
      if (sig !== NETV2.overallSig) {
        NETV2.overallSig = sig;
        NETV2.overallMap = res;
        renderNetV2Overall();
      }
    })
    .withFailureHandler(function(){ /* ignore */ })
    .getNetV2Overall();
}
/* FORCE RELOAD TABLE WHEN UPDATE TIME CHANGES */
function forceNetV2TableRefresh(){
  if (!(currentSheet === 'ðŸš€ Brand Battle (Stats)' || currentSheet === 'Net Net AnalysisV2')) return;
  google.script.run
    .withSuccessHandler(function(result){
      if (!result || result.error) return;
      NETV2.header = result.header;
      NETV2.raw = result.data || [];
      NETV2.sig = rowsSignature(NETV2.raw);
      withPreservedScroll(() => applyNetV2Filter(false));
    })
    .withFailureHandler(function(err){ console.error('forceNetV2TableRefresh failed:', err); })
    .getSheetData(currentSheet, currentSpreadsheetId);
}
/* Update time from A2 â€” if changed, refresh table immediately */
async function refreshUpdateTime(initial){
  google.script.run
    .withSuccessHandler(function(res){
      if (!res || res.error) return;
      const val = String(res.updateTime || '');
      const badge = document.getElementById('updateTimeBadge');
      if (val && val !== NETV2.updateTimeSig) {
        NETV2.updateTimeSig = val;
        if (badge) badge.textContent = `Update Time : ${val}`;
        forceNetV2TableRefresh();
      } else if (initial && val) {
        if (badge) badge.textContent = `Update Time : ${val}`;
        NETV2.updateTimeSig = val;
      }
    })
    .withFailureHandler(function(){ /* ignore */ })
    .getNetV2UpdateTime();
}
function miniFormatCell(v){
  if (v == null) return '';
  if (typeof v === 'string' && v.includes('%')) return v;
  const n = parseNumeric(v);
  if (n == null) return String(v);
  const out = Math.round(n).toLocaleString(undefined, { maximumFractionDigits: 0 });
  return n < 0 ? `<span class="num-neg">${out}</span>` : out;
}
/* Collapsible Overall box */
function toggleOverallBox(force){
  const box = document.getElementById('netv2-overall');
  const content = document.getElementById('netv2-overall-content');
  if (!box || !content) return;
  NETV2_UI.overallOpen = (typeof force === 'boolean') ? force : !NETV2_UI.overallOpen;
  localStorage.setItem('NETV2_OVERALL_OPEN', JSON.stringify(NETV2_UI.overallOpen));
  box.classList.toggle('open', NETV2_UI.overallOpen);
  content.style.display = NETV2_UI.overallOpen ? 'block' : 'none';
}
/* Overall renderer â€” 3rd-column DESC */
function renderNetV2Overall(){
  const box = document.getElementById('netv2-overall');
  const titleEl = document.getElementById('netv2-overall-title');
  const content = document.getElementById('netv2-overall-content');
  if (!box || !titleEl || !content) return;
  if (!(currentSheet === 'ðŸš€ Brand Battle (Stats)' || currentSheet === 'Net Net AnalysisV2')) { box.style.display = 'none'; return; }
  const seg = NETV2.segment;
  const map = NETV2.overallMap || {};
  const sortBy3rdDesc = rows => {
    if (!Array.isArray(rows)) return [];
    return rows.slice().sort((a,b)=>{
      const na = parseNumeric(a?.[2]); const nb = parseNumeric(b?.[2]);
      if (na === null && nb === null) return 0;
      if (na === null) return 1;
      if (nb === null) return -1;
      return nb - na;
    });
  };
  const renderBlock = (label, obj) => {
    if (!obj || !obj.header || !obj.header.length) return '';
    const rows = sortBy3rdDesc(obj.rows || []);
    let html = `<div style="margin:6px 0 6px 2px; font-weight:800; color:#1a2a44;">${label}</div>`;
    html += `<table class="mini-table"><thead><tr>${obj.header.map(h=>`<th>${h||''}</th>`).join('')}</tr></thead><tbody>`;
    rows.forEach(r => { html += `<tr>${r.map(c=>`<td>${miniFormatCell(c)}</td>`).join('')}</tr>`; });
    html += `</tbody></table>`;
    return html;
  };
  if (seg === 'ALL') {
    titleEl.textContent = `Overall â€” All`;
    const html = [
      renderBlock('CX', map.CX),
      renderBlock('MCW', map.MCW),
      renderBlock('BAJI', map.BAJI)
    ].join('') || `<div style="opacity:.75;">No Overall data found.</div>`;
    if (content.innerHTML !== html) content.innerHTML = html;
    box.style.display = 'block';
    toggleOverallBox(NETV2_UI.overallOpen);
    return;
  }
  const dataObj = map[seg] || { header:[], rows:[] };
  titleEl.textContent = `Overall â€” ${seg}`;
  box.style.display = 'block';
  if (!dataObj.header || !dataObj.header.length) {
    const html = `<div style="opacity:.75;">No Overall data found for ${seg}.</div>`;
    if (content.innerHTML !== html) content.innerHTML = html;
    toggleOverallBox(NETV2_UI.overallOpen);
    return;
  }
  const rows = sortBy3rdDesc(dataObj.rows || []);
  let html = `<table class="mini-table"><thead><tr>${dataObj.header.map(h=>`<th>${h || ''}</th>`).join('')}</tr></thead><tbody>`;
  rows.forEach(r=>{ html += `<tr>${r.map(c=>`<td>${miniFormatCell(c)}</td>`).join('')}</tr>`; });
  html += `</tbody></table>`;
  if (content.innerHTML !== html) content.innerHTML = html;
  toggleOverallBox(NETV2_UI.overallOpen);
}
/* ===== Controls (PATCH B): Section buttons include ALL + union currencies ===== */
async function buildNetV2Controls(header, rows){
  NETV2.header = header;
  NETV2.raw = Array.isArray(rows) ? rows : [];
  const segList = ['ALL','CX','MCW','BAJI'];
  const cmap = await loadNetV2CurrencyMap();
  const unionCurrencies = Array.from(new Set([
    ...(cmap?.CX || []),
    ...(cmap?.MCW || []),
    ...(cmap?.BAJI || [])
  ])).sort();
  const currList =
    NETV2.segment === 'ALL' ? unionCurrencies :
    NETV2.segment === 'MCW' ? (cmap?.MCW || []) :
    NETV2.segment === 'BAJI' ? (cmap?.BAJI || []) :
                               (cmap?.CX || []);
  const el = document.getElementById('netv2-controls');
  if (!el) return;
  el.style.display = 'block';
  el.innerHTML = `
    <div class="nnv2-row nnv2-seg"><strong>Section:</strong>
      ${segList.map(s => {
        const active = (NETV2.segment === s) || (s==='MCW' && NETV2.segment==='MCX');
        return `<button class="${active?'active':''}" data-seg="${s}">${s}</button>`;
      }).join(' ')}
    </div>
    <div class="nnv2-row nnv2-curr"><strong>Currencies:</strong>
      ${['ALL', ...currList].map(c => `<span class="chip ${NETV2.currency===c?'active':''}" data-d="${c}">${c}</span>`).join(' ')}
    </div>
  `;
  el.querySelectorAll('.nnv2-seg button').forEach(btn => {
    btn.onclick = async () => {
      NETV2.segment = btn.dataset.seg;
      NETV2.currency = 'ALL';
      await buildNetV2Controls(NETV2.header, NETV2.raw);
      withPreservedScroll(() => applyNetV2Filter(true));
      await ensureOverallLoaded();
      renderNetV2Overall();
    };
  });
  el.querySelectorAll('.nnv2-curr .chip').forEach(chip => {
    chip.onclick = async () => {
      const c = chip.dataset.d;
      NETV2.currency = (NETV2.currency === c && c !== 'ALL') ? 'ALL' : c;
      await buildNetV2Controls(NETV2.header, NETV2.raw);
      withPreservedScroll(() => applyNetV2Filter(false));
      renderNetV2Overall();
    };
  });
  document.getElementById('netv2-searchwrap').style.display = 'flex';
  document.getElementById('table-tools').style.display = 'flex';
  const searchInput = document.getElementById('netv2-search');
  if (searchInput && !searchInput.__hooked) {
    searchInput.__hooked = true;
    searchInput.addEventListener('input', debounce(() => {
      NETV2_SEARCH = searchInput.value || '';
      withPreservedScroll(() => applyNetV2Filter(false));
    }, 150));
  }
}
/* Filter â†’ hide Call/Currency â†’ search â†’ sort â†’ render */
function applyNetV2Filter(isInitial){
  const callIdx = findCol(NETV2.header, ['Call','Section','Segment','Group']);
  const currIdx = findCol(NETV2.header, ['Currency','Currencies']);
  let rows = NETV2.raw.filter(r => segMatch(NETV2.segment, r?.[callIdx]));
  if (NETV2.currency !== 'ALL' && currIdx >= 0) {
    rows = rows.filter(r => String(r?.[currIdx] || '').trim() === NETV2.currency);
  }
  const hideIdx = new Set([callIdx, currIdx].filter(i => i >= 0));
  let filteredHeader = NETV2.header.filter((_, i) => !hideIdx.has(i));
  let filteredRows = rows.map(r => r.filter((_, i) => !hideIdx.has(i)));
  filteredRows = applySearchRows(filteredRows, NETV2_SEARCH);
  if (TABLE_SORT.col != null) {
    filteredRows = sortRows(filteredRows, TABLE_SORT.col, TABLE_SORT.dir);
  }
  renderTable(filteredHeader, filteredRows, !!isInitial);
}
  </script>
</body>
</html>
